---
title: "【DB接続】データベース接続の最小権限から始めるセキュリティ改善"
emoji: "🛡️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["セキュリティ", "データベース", "AWS", "SQL"]
published: true
---

![](/images/db_security/Zenn_DB_secrity.png)

## はじめに

システム開発の初期段階では、利便性を優先してデータベースの管理者権限を持つユーザーをそのままアプリケーションの接続に使用してしまうことがあります。しかし、そのまま運用を続けることは、セキュリティ上の大きなリスクです。
本記事では、現状の調査から、リスクを段階的に低減させるためのステップについて解説します。

## 対象者

* 開発環境やステージング環境のセキュリティ設定に不安があるエンジニア
* 開発環境やステージング環境で管理者ユーザーをアプリに使用している方
* 環境変数ファイルにパスワードを平文で記載することに不安を感じている方

## リスクの観点

以下のような観点からDBの接続状況を確認し、リスク評価をしていきます。

### リスク1. 特権の過剰付与
管理者ユーザーはテーブルの削除やユーザー作成が可能です。SQLインジェクション攻撃を受けた際、データベース全体の消失につながります。

### リスク2. 認証情報の露出
サーバー侵入時、.env の平文パスワードにより、即座にデータベースの完全な制御権を奪われます。

### リスク3. ネットワーク経路の脆弱性
踏み台サーバーを経由しない直接接続は、インターネット上のあらゆる攻撃者に対してポートを開放している状態に近くなります。

## ステップ1 現状の実態調査

まずは、現在アプリケーションがどのような設定で動作しているかを正確に把握する必要があります。

### 1. サーバー内の認証用構成ファイルの特定
DB接続情報を見つけます。`.env` の場合やそれ以外にも、技術スタックによって様々なファイルに散らばっています。

- YAML形式
`docker-compose.yml` や `database.yml` など。

- JSON形式
`config.json` や `package.json` 内のスクリプト。

- PHP形式
`config.php` や `wp-config.php` など。

```bash
# PASSWORD や DB_ を含むファイルをディレクトリ内から再帰的に検索
grep -rnE "DB_USERNAME|DB_PASSWORD|MYSQL_ROOT_PASSWORD" my-project/
```

:::message
**ポイント**
ここで `DB_USERNAME` が `root` や `admin` になっている場合、注意が必要です。パスワードが平文（テキスト）で表示されることも、リスクであると再認識すべきです。
:::

### 2. データベース側での権限確認

次に、そのユーザーがデータベース上でどのような権限を持っているかを調査します。
DBクライアントアプリ（DBeaver や TablePlus など）やターミナルから、以下のSQLを実行してください。

```sql
-- 現在接続しているユーザーの権限を確認
SHOW GRANTS FOR CURRENT_USER;

-- または、特定のユーザー（例: admin）の権限を確認
SHOW GRANTS FOR 'admin'@'%';

# 出力例
GRANT ALL PRIVILEGES ON *.* TO `admin`@`%` WITH GRANT OPTION
```

出力結果に `ALL PRIVILEGES` や `WITH GRANT OPTION` 、あるいは `GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, ALTER...` と並んでいる場合、アプリケーションには過剰な権限が付与されている状態です。

## ステップ2 ユーザーの分離

調査で判明した過剰な特権を剥奪し、アプリケーション専用ユーザーへ移行します。

### アプリ専用ユーザーの作成と権限付与

```sql
-- 1. アプリ専用ユーザーの作成
CREATE USER 'webapp_user'@'%' IDENTIFIED BY '複雑なパスワード';

-- 2. 必要なデータ操作権限（DML）のみを付与
GRANT SELECT, INSERT, UPDATE, DELETE ON target_db_name.* TO 'webapp_user'@'%';

-- 3. 反映
FLUSH PRIVILEGES;

```

:::message
**ポイント**
DML（Data Manipulation Language）とは、データの検索、登録、更新、削除を行うためのSQL命令の総称です。
:::

この作業により、たとえアプリケーション経由で不正操作を試みられても、データベース構造自体の破壊や他ユーザーの操作を防ぐことができます。これは、最小権限の原則に基づいた対策です。

:::message
**ポイント**
最小権限の原則とは、ユーザーやシステムに対し、その業務を遂行するために必要な最小限の権利だけを割り当てるという情報セキュリティの基本概念です。
:::

## ステップ3 パスワードの隠蔽

環境変数ファイル（.env）にパスワードを記載する方法は、開発初期には手軽ですが、誤ってリポジトリにコミットしてしまうリスクや、サーバー内に平文でファイルが残るリスクがあります。さらなる堅牢化を目指す場合、`AWS Secrets Manager` などのマネージドサービスを活用して、認証情報を外部化することを推奨します。

### アプリケーションへの組み込み方

主に以下の2つのパターンがあります。

-   **API経由での取得**: アプリケーション起動時にAWS SDKを使用してSecrets Managerから認証情報を取得する。
-   **環境変数への注入**: AWS ECSやLambdaなどの機能を利用し、コンテナや関数の起動時に環境変数としてSecrets Managerの値を展開する。

:::message
**ポイント**
AWS Secrets Managerとは、データベースの認証情報などの機密情報を安全に保存、管理、取得するためのサービスです。
:::

## ステップ4 接続経路の高度化

データベースがインターネットから直接アクセス可能な場所（パブリックサブネット）にある場合、ファイアウォール（Security Group）で制限していても、運用設定ミスやゼロデイ脆弱性により攻撃を受けるリスクが残ります。データベースはインターネットから遮断されたプライベートサブネットに配置し、以下のいずれかの方法で安全な接続経路を確保します。

### 1. 踏み台サーバー（Bastion）の利用

一般的な手法です。パブリックサブネットに「踏み台（Bastion）」と呼ばれる中継用サーバーを1台配置し、そこを経由してプライベートなDBへ接続します。

### 2. SSM Session Managerの利用（推奨）

よりモダンでセキュアな構成として、`AWS Systems Manager (SSM) Session Manager` を利用する方法があります。

:::message
**ポイント**
新規構築であれば、管理コストとセキュリティの観点からSSM Session Managerの採用を推奨します。既存環境でSSM導入が難しい場合は、踏み台サーバーのアクセス制限を厳格化（特定のIPのみ許可など）することから始めることをおすすめします。
:::

以上で、3つ観点からリスクを評価したデータベースのセキュリティを向上させるための基本的な対策は完了です。

---

### おわりに

管理者ユーザーから専用ユーザーへ切り替えるだけでも、あなたの守るシステムのリスクは劇的に下がります。まずは現状のリスクを評価してみるのはいかがでしょうか。一つずつ構成を見直していくことがデータベースの堅牢化に繋がります。本記事がその一助になれば幸いです。

---

## 株式会社ONE WEDGE
【Serverlessで世の中をもっと楽しく】
ONE WEDGEはServerlessシステム開発を中核技術としてWeb系システム開発、AWS/GCPを利用した業務システム・サービス開発、PWAを用いたモバイル開発、Alexaスキル開発など、元気と技術力を武器にお客様に真摯に向き合う価値創造企業です。
https://onewedge.co.jp/
