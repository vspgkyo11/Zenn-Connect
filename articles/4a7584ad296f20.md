---
title: "【Node.js】AWS EC2 (Debian 12) で Node.js 20 から v24/v25 へアップグレードガイド"
emoji: "🚀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["nodejs","docker","infra"]
published: false
---

![](/images/nodejs20-upgrade/zenn_nodejs20-24-25.png)

## はじめに

クラウド環境での運用において、ランタイムのアップデートは避けて通れません。昨今では、Node.js v24がLTSとなり、セキュリティ水準が一段階引き上げられました。
本記事では、AWS EC2上のDebian 12環境において、既存のNode.js 20を安全に、かつ最短ルートで最新の安定版（v24）または最新機能版（v25）へアップグレードする手順を解説します。

## 対象者

* AWS EC2（Debian 12 / Bookworm）を利用している方
* Node.js 20系から v24 (LTS) または v25 (Current) への移行を検討している方
* apt 経由でのパッケージ管理をクリーンに保ちたいエンジニア



## なぜ今回のガイドで `apt` を選んだのか

本番環境（EC2）において `nvm` ではなく `apt` を選ぶべき理由は、主に3つのリスクを回避するためです。

### 1. 起動トラブル（Systemd等との相性）

EC2でNode.jsを実行する場合、`systemd` を使って常駐化させるのが一般的です。`nvm` はシェルの設定ファイル（.bashrcなど）を読み込まないとパスが通りません。そのため、systemdから起動しようとした際に「Nodeが見つからない」というエラーが頻発します。`apt` で入れれば `/usr/bin/node` に固定されるため、設定が非常にシンプルになります。

### 2. cron や自動化スクリプトの実行

定期実行タスク（cron）はログインシェルを介さないため、`nvm` で入れた Node はそのままでは実行できません。本番運用において、実行環境が「ユーザー設定」に依存するのは事故の元です。

### 3. セキュリティと再現性

商用環境では「どのユーザーが実行しても同じバージョンが動く」という一貫性が重要です。`apt` 管理であれば、サーバー管理者がパッケージリストを見るだけでインストール状況を一目で把握できます。

---

## 結論：どちらの手順が良い？

* **今回のガイド（apt）が最適なケース：**
* サービスを安定稼働させたい本番環境。
* systemd や pm2 を使ってデーモン化（常駐化）させたい場合。
* チームでサーバーを共有管理している場合。


* **nvm が最適なケース：**
* 自分のPCでの開発作業（プロジェクトごとにバージョンを頻繁に変える必要がある）。
* 1台のサーバー内で、ユーザーAはv20、ユーザーBはv24を使い分けたいという特殊な状況。



> **注釈：nvm を本番で使うリスク**
> nvmはあくまで「シェルの環境変数を書き換えて見かけのバージョンを変える」ツールです。本番環境の「システムそのもの」をアップグレードする今回の要件では、OS標準のパッケージ管理機構（apt）に乗るのが最も安全で、Debianの作法に則った形となります。


## なぜ nvm ではなく apt（NodeSource）なのか
開発環境では nvm や asdf が便利ですが、本番サーバーの「システム基盤」としては apt による直接インストールを推奨します。その理由は、運用の堅牢性にあります。

1. サービス管理（systemd）との親和性
本番環境では systemd でNodeプロセスを管理するのが一般的です。nvm はログインシェルに依存するため、systemd から起動する際に「Nodeが見つからない」というパスエラーを引き起こしがちです。/usr/bin/node に実体を配置する apt なら、設定が極めてシンプルになります。

2. 環境の不変性とシンプルさ
Docker を使うのは非常に良い選択肢ですが、既存のEC2構成（生身のOS上で動かしている場合）において、わざわざ Docker レイヤーを導入すると管理コストやリソース消費が増える場合があります。一方、asdf 等は複数バージョン共存には強いものの、本番環境の「OSの標準パッケージ管理（apt）」の枠組みから外れるため、セキュリティアップデートの追跡が独自管理になってしまうデメリットがあります。

注釈：管理が煩雑にならないか？ 「aptだとバージョン固定が難しい」と思われがちですが、NodeSourceリポジトリを使えば、OSを汚さず特定のメジャーバージョンをクリーンに追従できます。


## パッケージ管理の比較：apt vs nvm

| 比較項目 | apt (NodeSource) | nvm |
| --- | --- | --- |
| **主な用途** | **本番サーバー・商用環境** | **ローカル開発環境** |
| **実行ユーザー** | システム全体（/usr/bin/node） | ログインユーザーごと（~/.nvm/） |
| **パスの解決** | 固定されるため、サービス化が容易 | シェルの設定に依存するため、cron等で躓きやすい |
| **自動更新** | aptのセキュリティアップデート対象 | 手動での切り替えが必要 |

---

## 1. 事前準備：現状確認とバックアップ

作業を開始する前に、現在の環境を正しく把握しましょう。

```bash
# 現在のバージョンを確認
node -v
# 期待値: v20.x.x

# npmの場所を確認
which npm
# /usr/bin/npm などが表示されることを確認

```

> **注釈：LTS（Long Term Support）と Current**
> LTS（v24）は長期間の保守が保証された本番環境推奨版です。一方、Current（v25）は最新機能が含まれますがサポート期間が短いため、用途に合わせて選択してください。

## 2. 旧リポジトリのクリーンアップ

Debian 12では、NodeSourceのリポジトリ設定が `/etc/apt/sources.list.d/` に保存されています。古い設定が残っていると競合の原因になるため、一度リセットします。

```bash
# 既存のNodeSourceリストを確認
ls /etc/apt/sources.list.d/nodesource.list

# 不要な古いソースを削除
sudo rm -f /etc/apt/sources.list.d/nodesource.list
```

## 3. Node.js v24 (LTS) または v25 の導入

'NodeSource'　は、より簡便なセットアップスクリプトを提供しています。ここでは、現在の主流である `v24.x` を例に進めます。

### リポジトリの登録

```bash
# v24 (LTS) を導入する場合
curl -fsSL https://deb.nodesource.com/setup_24.x | sudo -E bash -

# v25 (Current) を導入したい場合はこちら
# curl -fsSL https://deb.nodesource.com/setup_25.x | sudo -E bash -
```

### インストールの実行

リポジトリ情報が更新されたら、パッケージをインストールします。

```bash
# パッケージリストの更新
sudo apt-get update

# Node.jsのインストール
sudo apt-get install -y nodejs
```

> **注釈：build-essential の重要性**
> ネイティブモジュール（node-gyp等）を使用するライブラリをnpmで扱う場合、`sudo apt-get install -y build-essential` も併せて実行しておくのが定石です。

## 4. 正常性の確認と後処理

インストールが完了したら、バージョンが正しく反映されているか確認します。

```bash
node -v
# v24.11.0 (2026年2月時点のLTS) などが表示されれば成功です

npm -v
# Node.jsに同梱されているnpmのバージョンも更新されています
```

最後に、既存のプロジェクトで依存関係を再構築することをお勧めします。

```bash
# 各プロジェクトディレクトリにて
rm -rf node_modules
npm install
```

## おわりに

サーバーのアップデート作業、本当にお疲れ様です。
私自身、かつてEC2上のNode.jsを適当にアップデートしてしまい、依存ライブラリの不整合でサービスを数時間止めてしまった苦い経験があります。あの時の真っ青になった感覚は今でも忘れられません。
だからこそ、こうした「確実な手順」が誰かの安心に繋がればいいなと思い、この記事を書きました。コマンドを一つずつ叩くその慎重さは、あなたがエンジニアとして「誠実」である証拠です。この記事が、あなたの開発運用を少しでも穏やかにすることを願っています。

---

# はじめに

Laravel本体のアップグレード、お疲れ様でした。
しかし、アプリケーションの近代化はフレームワークの更新だけでは完結しません。それを動かすエンジンである「言語（PHP）」と「ランタイム（Node.js）」もまた、時代に合わせて載せ替える必要があります。

本記事は「Laravel最新化プロジェクト」       スタンダードとなる **PHP 8.5** および **Node.js 24** への移行手順と、それに伴う修正ポイントを解説します。

## 対象者

* Laravel 12 への移行が完了している方
* Dockerなどのコンテナ環境で開発している方
* `Deprecated` （非推奨）という警告ログを根絶したい方



## ステップ1 PHP 8.5 への引き上げ

まずはサーバーサイドの言語バージョンを更新します。
PHP 8.5 はパフォーマンスの向上に加え、より厳格な型安全性を提供します。

### Dockerfile の修正

`docker/app/Dockerfile` などの定義ファイルを編集し、ベースイメージを更新します。

```dockerfile
# PHP 8.3 から 8.5 へ変更します
FROM php:8.5-apache

# 必要な拡張機能のインストール（例: Imagick）
RUN pecl install imagick && docker-php-ext-enable imagick

# その他の設定は既存のものを維持します

```

### コンテナの再ビルド

設定を変更したら、キャッシュを使わずにビルドし直します。

```bash
docker-compose build --no-cache
docker-compose up -d

```

起動後、コンテナ内でバージョンを確認します。

```bash
php -v

```

期待される結果
`PHP 8.5.x (cli)` と表示されること。

## ステップ2 PHP 8.5 における PDO 定数の修正

PHP 8.5 へ移行した直後、データベース接続周りで以下のような非推奨エラー（Deprecated）が発生することがあります。

エラー内容
`Deprecated: Constant PDO::MYSQL_ATTR_SSL_CA is deprecated since 8.5, use Pdo\Mysql::ATTR_SSL_CA instead`

### 原因と対策

PHP 8.5 では、データベース関連の定数が整理され、名前空間付きの定数へと移行が進んでいます。これまでの `PDO::MYSQL_ATTR_SSL_CA` は非推奨となり、代わりに `Pdo\Mysql::ATTR_SSL_CA` を使用する必要があります。

`config/database.php` を開き、MySQLの設定オプションを修正します。

修正前

```php
'options' => extension_loaded('pdo_mysql') ? array_filter([
    PDO::MYSQL_ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
]) : [],

```

修正後
まず、ファイルの先頭で新しい名前空間をインポートします。

```php
use Pdo\Mysql;

```

続いて、オプション配列内の定数を書き換えます。

```php
'options' => extension_loaded('pdo_mysql') ? array_filter([
    Mysql::ATTR_SSL_CA => env('MYSQL_ATTR_SSL_CA'),
]) : [],

```

これで非推奨警告は解消されます。

## ステップ3 Node.js 24 (LTS) への移行

続いて、フロントエンドのビルド環境を最新のLTS（長期サポート）版である Node.js 24 へ更新します。

### Dockerfile の修正と再インストール

Dockerfile 内で Node.js をインストールしている箇所を更新します。

```dockerfile
# Node.js v24 & npm最新化
RUN curl -sL https://deb.nodesource.com/setup_24.x | bash \
    && apt-get install -y nodejs \
    && npm install -g npm@latest

```

### パッケージのクリーンインストール

Node.js のメジャーバージョンアップ後は、`node_modules` のバイナリ互換性が失われることが多いため、必ず再構築を行います。

```bash
# 既存の依存ファイルを削除します
rm -rf node_modules package-lock.json

# 新しいNode環境でインストールし直します
npm install

# ビルドが通るか確認します
npm run build

```

最後に、脆弱性監査を行います。

```bash
npm audit

```

ここで脆弱性が報告された場合は `npm audit fix` を実行し、可能な限り修正を行ってください。

## 最終確認

これですべてのレイヤー（Laravel, PHP, Node.js）が最新化されました。
最後に以下のコマンドでアプリケーション全体の健全性をチェックします。

```bash
# キャッシュをクリア
php artisan optimize:clear

# テストの実行
php artisan test

# バージョン情報の最終確認
php artisan about

```

## おわりに

全3回にわたるアップグレード作業、本当にお疲れ様でした。

最初は「脆弱性対応」というマイナスをゼロに戻す作業から始まりました。
次に「Laravel 12への移行」でシステムを現代の水準に合わせました。
そして今回、PHPとNode.jsを最新化することで、未来へ進むための準備が整いました。

ターミナルに表示される `PHP 8.5` や `Node.js v24` という文字列は、単なる数字ではありません。それは、私たちが技術的負債という重力に抗い、システムを前進させた証です。

この一連の記事が、あなたのシステムの寿命を延ばし、開発する楽しさを取り戻すきっかけになれば、これ以上の喜びはありません。

---

## 株式会社ONE WEDGE
【Serverlessで世の中をもっと楽しく】
ONE WEDGEはServerlessシステム開発を中核技術としてWeb系システム開発、AWS/GCPを利用した業務システム・サービス開発、PWAを用いたモバイル開発、Alexaスキル開発など、元気と技術力を武器にお客様に真摯に向き合う価値創造企業です。
https://onewedge.co.jp/
