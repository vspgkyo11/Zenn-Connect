---
title: "【Mac容量不足】エンジニアのストレージ最適化ガイド"
emoji: "💾"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["storage", "macOS", "Docker", "pnpm"]
published: true
---

![](/images/mac-storage-full/zenn_img_storage-full.png )

## はじめに

MacBookのストレージ残量が枯渇しかけて、正体不明のデータに容量を圧迫されていませんか？
ストレージをなんらかのデータが占拠してしまうことは、誰にでも起こりうることです。もちろんクリーナーソフトを使うことも良いですが、本記事では、エンジニアならではのコマンドラインを用いて原因を特定し、安全かつ論理的にストレージを最適化する手法を解説します。

特に、エンジニアの場合、Dockerや各種パッケージマネージャー（npm, pnpmなど）を日常的に使用していると、知らぬ間にギガ単位のデータが深層に蓄積されているかもしれません。本記事では、Macのライブラリ構造を紐解きながら、最適な開発環境を取り戻すコマンドも紹介します。

## 対象者

* 容量不足に悩むユーザー
* macOSのライブラリ構造を理解し、安全にクリーンアップを行いたい方
* Dockerやnpm/pnpmなどの開発ツールを利用しているエンジニア

---

## 現状の可視化と要因の特定

macOSのストレージ管理画面では、システムデータの内訳は詳細に表示されません。しかし、まずはこの画面で絶望的な状況を直視することから始まります。
私は、ストレージ残量が少ないとアラートが表示されたので、ゴミ箱を空にしたり、不要なアプリケーションやデータを削除したものの、状況はあまり改善されませんでした。

![](/images/mac-storage-full/zenn-mac-storage-88GB.png =250x)
*システムデータが圧迫している様子（例：220.16GB/245.11GB）*

そこで、まずはターミナルから、どのディレクトリが肥大化しているか、その要因を階層的に探ります。
ここでは、以下のコマンドを実行します。
`du -sh`: ディレクトリの容量を計算します（`-s`: サマリーのみ, `-h`: 人が見やすい単位で表示）。
`sort -rh`: 容量の大きい順に並べ替えます（`-r`: 降順, `-h`: K/M/Gなどの単位を考慮してソート）。
`head -n 10`を指定して、上位10件を表示していますが、必要に応じて適切な数値を指定してください。

```bash
# sudoが必要な場合は、sudoを付けて実行してください
sudo du -sh ~/* | sort -rh | head -n 10

# 出力例
# 88G     /Users/username/Library
# 15G     /Users/username/Documents
# 10G     /Users/username/Downloads
# ...
```

次に、特に容量の多かったディレクトリに絞り、ユーザーライブラリ内のディレクトリ容量を大きい順に表示します。

```bash
# ライブラリ内のディレクトリ容量を大きい順に表示します
sudo du -sh ~/Library/* | sort -rh | head -n 10

# 出力例
# 25G     /Users/username/Library/Containers
# 18G     /Users/username/Library/Application Support
# 12G     /Users/username/Library/Caches
# ...
```

多くのエンジニア環境において、以下の3つが主要な要因となりやすいです。

1. ~/Library/Containers
各アプリケーションのサンドボックスデータが格納される領域です。
2. ~/Library/Application Support
IDEのエクステンションや、Cursorなどのエディタが保持するインデックスデータが含まれます。
3. ~/Library/Caches
ビルドキャッシュやパッケージマネージャの退避データが蓄積されます。

:::message
**注意事項**
`du`コマンド実行時に `Operation not permitted` と表示される場合は、システム設定のプライバシーとセキュリティから、ターミナルに対して「フルディスクアクセス」を許可する必要があります。
:::

:::message alert
**要注意**
フルディスクアクセス権限は、非常に強力な権限です。作業完了後は必要に応じて設定を解除することを推奨します。
:::


## 開発ツール由来の冗長なデータを削減する

エンジニアのストレージを圧迫する要因として、プロジェクトごとの依存関係とコンテナイメージの残骸であることも多いです。

### パッケージマネージャのキャッシュ/ストア整理

ストレージを圧迫する要因の一つに、パッケージマネージャのキャッシュやストアデータがあります。


#### npmの場合：キャッシュの削除

npmのキャッシュが肥大化している場合は、以下のコマンドで削除できます。

```bash
npm cache clean --force
```

#### pnpmの場合：ストアの最適化

pnpmは依存関係をグローバルに保存するため、削除済みのプロジェクトの依存パッケージが残存することがあります。

```bash
pnpm store prune
```

この操作により、どのプロジェクトからも参照されていない不要なアセットが安全に削除されます。

### Dockerのビルドキャッシュ削除

Docker は使用していないオブジェクト（イメージ、コンテナ、ボリューム、ネットワーク）に対するクリーンアップには、`docker system prune`コマンドを用いることが推奨されます。

```bash
docker system prune
```

しかし、`docker system prune` だけでは削除しきれないビルドキャッシュが残っている場合があります。

その場合は、以下のコマンドでキャッシュのみを削除してみましょう。
このコマンドは、DockerのBuildKitが保持しているビルド時のキャッシュを削除します。
ただし、次回のビルド時にキャッシュが効かないため、ビルド時間が長くなります。稼働中のコンテナやイメージそのものが消えることはありません。

```bash
docker builder prune -f
```

### Dockerの物理容量解放と注意点

`docker system prune` を実行しただけでは、Mac上の実ファイルである `Docker.raw` のサイズは縮小されません。これはDocker Desktop for Macがディスクの最大枠を事前に確保する仕様のためです。

1. Docker Desktopの設定画面を開く
2. ResourcesからDisk image sizeを確認する
3. スライダーを動かして予約サイズ自体を縮小する

:::message
**注意事項**
この操作を実行すると、既存のイメージやボリューム、コンテナデータがすべて消失します。実行前に、必要なデータベースのダンプや重要なボリュームのバックアップを必ず取得してください。
:::

## 汎用的なキャッシュの削除
 
システム全体のキャッシュファイルを削除することで、ストレージを確保できる場合があります。
 
:::message alert
**実行前のリスク確認**
このコマンドを実行すると、**LINEのトーク履歴内の画像**や**Spotifyのオフライン楽曲**、Adobe製品のメディアキャッシュなどが削除される可能性があります。
念の為、Time Machine等で**バックアップを取得してから実行すること**を強く推奨します。
:::
 
一括削除をするのが不安な場合は、まずはどのキャッシュが肥大化しているかを確認しましょう。

```bash
# キャッシュディレクトリ内の容量Top 5を表示
du -sh ~/Library/Caches/* | sort -rh | head -n 5

# 出力例
# 10G     /Users/username/Library/Caches/Spotify
# 5G      /Users/username/Library/Caches/LINE
# ...

# 例：不要だと判断できた場合、SpotifyとLINEのキャッシュを削除
rm -rf ~/Library/Caches/Spotify
rm -rf ~/Library/Caches/LINE
```

リスクを許容できる場合のみ、以下のコマンドで一括削除
 
```bash
rm -rf ~/Library/Caches/*
```
 
このコマンドは、各アプリケーション（ブラウザ、エディタ、Spotifyなど）が一時的に保存しているデータを一括で削除します。
数GBの空き容量を即座に確保できる場合がありますが、LINEやSpotifyなどで、オフラインデータの削除や、データの読み込み直し、再ダウンロードが発生します。
また、各アプリが次回起動時にキャッシュを再生成するため、動作が一時的に重くなる可能性があります。
※実行中は可能な限りアプリケーションを終了させておくことを推奨します。

## クリーンアップ後の様子

これらのコマンドを実行すると、システムデータが約15GB削減され、ストレージの空き容量が増加しました。

![](/images/mac-storage-full/zenn-mac-storage-73GB.png =250x)
*クリーンアップ後の様子（例：203.56GB/245.11GB）*

---

## おわりに

最適なパフォーマンスを維持するためにストレージの空き容量は必須です。
私自身、ストレージのアラートが突然出た時は何が容量を食いつぶしているのか分からず困りましたが、構造を理解し、一つひとつ要因を特定していきながら、少しずつ整理しています。
今回紹介した手法が、私と同じようにストレージ容量が足りない方の助けになれば幸いです。

---

## 株式会社ONE WEDGE
【Serverlessで世の中をもっと楽しく】
ONE WEDGEはServerlessシステム開発を中核技術としてWeb系システム開発、AWS/GCPを利用した業務システム・サービス開発、PWAを用いたモバイル開発、Alexaスキル開発など、元気と技術力を武器にお客様に真摯に向き合う価値創造企業です。
https://onewedge.co.jp/
